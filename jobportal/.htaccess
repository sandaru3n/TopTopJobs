# ----------------------------------------------------------------------
# CodeIgniter 4 Root .htaccess
# Redirects all requests to the public folder
# For production when document root is set to jobportal folder
# ----------------------------------------------------------------------

# Disable directory browsing (IMPORTANT for security)
Options -Indexes

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Redirect /public/ URLs to clean URLs (remove /public/ from URL)
    # This ensures URLs like https://toptopjobs.com/public/login redirect to https://toptopjobs.com/login
    # Also handles /public/api/jobs.php -> /api/jobs.php
    RewriteCond %{THE_REQUEST} \s/+(.+?/)?public/([^\s?]*) [NC]
    RewriteRule ^ /%2 [R=301,L]
    
    # If accessing root directory, redirect to public
    RewriteCond %{REQUEST_URI} ^/$
    RewriteRule ^(.*)$ public/ [L]
    
    # If the request is for a file that exists in root, serve it directly (like .htaccess itself)
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ - [L]
    
    # If the request is for a directory that exists in root, serve it directly
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]
    
    # Rewrite all requests to public folder (let public/.htaccess handle file serving)
    # This handles /api/jobs.php -> /public/api/jobs.php (internally)
    # The public/.htaccess will serve existing files directly
    RewriteCond %{REQUEST_URI} !^/public/
    RewriteRule ^(.*)$ public/$1 [L]
</IfModule>

# Deny access to sensitive files and directories
# Apache 2.4+ syntax (preferred for production)
<FilesMatch "^\.">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Protect .env file
<Files ".env">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</Files>

# Protect sensitive directories and files
<IfModule mod_rewrite.c>
    RewriteEngine On
    # Block direct access to app, writable, vendor, tests, database, and other sensitive directories
    RewriteRule ^(app|writable|vendor|tests|database|spark|composer\.(json|lock)|phpunit\.xml\.dist|\.env|\.git) - [F,L]
</IfModule>

